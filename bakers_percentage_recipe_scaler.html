<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Baker's Percentage Recipe Scaler (Shareable URL)</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    table { border-collapse: collapse; margin-bottom: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; }
    input[type="number"] { width: 80px; }
    .add-row { margin-bottom: 1em; }
    .results { margin-top: 2em; }
    label { display: block; margin: 0.5em 0; }
    .url-box { background: #eef; padding: 1em; margin: 1em 0; word-break: break-all; }
  </style>
</head>
<body>
  <h1>Baker's Percentage Recipe Scaler</h1>
  <div>
    <label>
      Total Dough Weight per piece (grams):
      <input type="number" id="total-dough-weight" value="225" min="1" required>
    </label>
    <label>
      Number of pieces:
      <input type="number" id="multiplier" value="2" min="1" required>
    </label>
  </div>
  <form id="recipe-form">
    <table id="ingredients-table">
      <thead>
        <tr>
          <th>Ingredient</th>
          <th>Baker's %</th>
          <th>Remove?</th>
        </tr>
      </thead>
      <tbody id="ingredients-body">
        <tr>
          <td><input type="text" value="Flour" readonly></td>
          <td><input type="number" value="100" min="0" step="0.1" required></td>
          <td></td>
        </tr>
        <tr>
          <td><input type="text" value="Water"></td>
          <td><input type="number" value="65" min="0" step="0.1" required></td>
          <td><button type="button" onclick="removeRow(this)">X</button></td>
        </tr>
        <tr>
          <td><input type="text" value="Salt"></td>
          <td><input type="number" value="2.4" min="0" step="0.1" required></td>
          <td><button type="button" onclick="removeRow(this)">X</button></td>
        </tr>
        <tr>
          <td><input type="text" value="Yeast"></td>
          <td><input type="number" value="0.6" min="0" step="0.1" required></td>
          <td><button type="button" onclick="removeRow(this)">X</button></td>
        </tr>
        <tr>
          <td><input type="text" value="Vinegar/Lemon Juice"></td>
          <td><input type="number" value="0.6" min="0" step="0.1" required></td>
          <td><button type="button" onclick="removeRow(this)">X</button></td>
        </tr>
      </tbody>
    </table>
    <button type="button" class="add-row" onclick="addRow()">Add Ingredient</button>
    <br>
    <button type="submit">Calculate</button>
  </form>
  <div class="url-box">
    <strong>Shareable Link:</strong>
    <span id="share-url"></span>
    <button onclick="copyUrl()">Copy URL</button>
  </div>
  <div class="results" id="results"></div>

  <script>
    // Utility functions
    function encodeIngredients(ingredients) {
      // ingredients: array of {name, percent}
      return ingredients.map(ing =>
        encodeURIComponent(ing.name) + ':' + encodeURIComponent(ing.percent)
      ).join(',');
    }
    function decodeIngredients(str) {
      // returns array of {name, percent}
      if (!str) return [];
      return str.split(',').map(pair => {
        const parts = pair.split(':');
        return {
          name: decodeURIComponent(parts[0] || ''),
          percent: parseFloat(decodeURIComponent(parts[1] || '0'))
        };
      });
    }
    function updateUrlFromForm() {
      const weight = document.getElementById('total-dough-weight').value;
      const multiplier = document.getElementById('multiplier').value;
      const rows = Array.from(document.getElementById('ingredients-body').querySelectorAll('tr'));
      const ingredients = rows.map(row => ({
        name: row.cells[0].querySelector('input').value.trim(),
        percent: row.cells[1].querySelector('input').value
      }));
      const qs = `?weight=${encodeURIComponent(weight)}&multiplier=${encodeURIComponent(multiplier)}&ingredients=${encodeIngredients(ingredients)}`;
      const url = location.pathname + qs;
      window.history.replaceState(null, '', url);
      document.getElementById('share-url').textContent = location.origin + url;
    }
    function fillFormFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const weight = params.get('weight');
      const multiplier = params.get('multiplier');
      const ingredientsStr = params.get('ingredients');
      if (weight) document.getElementById('total-dough-weight').value = weight;
      if (multiplier) document.getElementById('multiplier').value = multiplier;
      if (ingredientsStr) {
        const tbody = document.getElementById('ingredients-body');
        tbody.innerHTML = '';
        decodeIngredients(ingredientsStr).forEach((ing, i) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><input type="text" value="${ing.name}" ${i===0?'readonly':''}></td>
            <td><input type="number" value="${ing.percent}" min="0" step="0.1" required></td>
            <td>${i===0?'':`<button type="button" onclick="removeRow(this)">X</button>`}</td>
          `;
          tbody.appendChild(row);
        });
      }
    }
    function copyUrl() {
      const url = document.getElementById('share-url').textContent;
      navigator.clipboard.writeText(url);
      alert('URL copied to clipboard!');
    }
    function addRow() {
      const tbody = document.getElementById('ingredients-body');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" value=""></td>
        <td><input type="number" value="0" min="0" step="0.1" required></td>
        <td><button type="button" onclick="removeRow(this)">X</button></td>
      `;
      tbody.appendChild(row);
      updateUrlFromForm();
    }
    function removeRow(btn) {
      const row = btn.closest('tr');
      row.remove();
      updateUrlFromForm();
    }

    // Initial load - fill form if URL params exist
    fillFormFromUrl();
    updateUrlFromForm();

    // Update URL whenever inputs change
    document.getElementById('total-dough-weight').addEventListener('input', updateUrlFromForm);
    document.getElementById('multiplier').addEventListener('input', updateUrlFromForm);
    document.getElementById('ingredients-body').addEventListener('input', updateUrlFromForm);

    // Calculation logic
    document.getElementById('recipe-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const totalDoughWeight = parseFloat(document.getElementById('total-dough-weight').value);
      const multiplier = parseInt(document.getElementById('multiplier').value, 10);

      const tbody = document.getElementById('ingredients-body');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      let totalBakersPercent = 0;
      let ingredients = [];

      rows.forEach((row, i) => {
        const name = row.cells[0].querySelector('input').value.trim() || "Ingredient";
        const percent = parseFloat(row.cells[1].querySelector('input').value);
        if (!isNaN(percent)) {
          totalBakersPercent += percent;
          ingredients.push({ name, percent });
        }
      });

      if (totalBakersPercent === 0) {
        document.getElementById('results').innerHTML = "<p style='color: red;'>Baker's percent total cannot be zero.</p>";
        return;
      }

      // Calculate flour weight for ONE loaf
      const flourWeight = totalDoughWeight / (totalBakersPercent / 100);

      let resultsHtml = `<h2>Scaled Recipe</h2><table><thead><tr><th>Ingredient</th><th>Baker's %</th><th>Per Loaf (g)</th><th>Total (g)</th></tr></thead><tbody>`;
      let sumPerLoaf = 0;
      let sumTotal = 0;

      ingredients.forEach((ing) => {
        const perLoaf = flourWeight * (ing.percent / 100);
        const total = perLoaf * multiplier;
        resultsHtml += `<tr><td>${ing.name}</td><td>${ing.percent.toFixed(1)}</td><td>${perLoaf.toFixed(1)}</td><td>${total.toFixed(1)}</td></tr>`;
        sumPerLoaf += perLoaf;
        sumTotal += total;
      });

      resultsHtml += `<tr style="font-weight:bold;"><td>Total</td><td>${totalBakersPercent.toFixed(1)}</td><td>${sumPerLoaf.toFixed(1)}</td><td>${sumTotal.toFixed(1)}</td></tr>`;
      resultsHtml += "</tbody></table>";

      document.getElementById('results').innerHTML = resultsHtml;
      updateUrlFromForm();
    });
  </script>
</body>
</html>